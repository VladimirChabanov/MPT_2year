# Практическое задание 2. Управление пользователями и правами.

## Основные теоретические сведения

**Цель:** Изучение команд операционной системы Linux по управлению пользователями и правами доступа файлам и каталогам.

**Теоретическая часть:**

Компьютерные системы предназначены для обслуживания людей. Человек, реально управляющий компьютером либо считающий себя таковым, называется его пользователем. Различие между обычными пользователями, администраторами и программистами заключается не только в решаемых задачах, но и в степени их полномочий и компетентности. Так, администратор компьютерной системы одновременно является и пользователем системы защиты, и программистом командных сценариев. Большинство программистов, по сути дела, давно превратились в пользователей интегрированной среды программирования.

Плохо, если управление ответственными вычислительными процессами доверяется некомпетентным пользователям, но гораздо хуже передать его чужому человеку, который может оказаться злоумышленником. Решить библейскую задачу отделения «агнцев от козлищ» должна встроенная в ОС система управления доступом. Защищенная операционная система обслуживает только своих пользователей, которых она должна уметь правильно распознавать.

Человеку свойственно иметь имя. Впрочем, операционную систему не интересуют подлинные имена и фамилии людей, ей необходимо знать лишь учетные имена, по которым каждого из пользователей можно идентифицировать, т. е. отличать от других. Пользователь в системе имеет два идентификатора: символьный и числовой. Символьный идентификатор, именуемый учетным именем пользователя, используется в качестве идентификатора для входа в систему. Он предназначен собственно для самого пользователя и не должен начинаться с цифры, содержать заглавных и русских букв, а также символов типа `* # % ^`. Когда пользователь докажет системе, что он действительно тот, за кого себя выдает, система теряет интерес и к его учетному имени. После успешной аутентификации система помнит пользователя за каждым терминалом только по номеру и помечает этим номером каждый запущенный пользовательский процесс и созданный файл.

Система при регистрации присваивает каждому пользователю уникальный числовой идентификатор (UID – User ID). Этих номеров намного больше, чем требуется для подсчета пользователей системы. Первоначально для их нумерации в метаданных файлов было зарезервировано два байта, что было достаточно для создания 216 = 65536 учетных записей. Впоследствии это число почему-то сочли недостаточным, и соответствующие поля индексного дескриптора в совокупности были увеличены до 4 байтов, что позволяет довести число пользователей одной операционной системы до невообразимой величины, равной 4294967296 (свыше 4 млрд. чел.). Пользователь с UID = 0 по умолчанию имеет учетное имя root и является для системы администратором (суперпользователем). Система не позволяет регистрировать более одного суперпользователя, но это можно 12 сделать «в обход», путем непосредственного редактирования файла с учетными записями. Подобным образом, как будет показано ниже, можно создать произвольное число учетных записей с нулевым идентификатором, и каждый из таких зарегистрированных пользователей будет обладать правами администратора.

Как говорят, root – это не право, а возможность не считаться ни с какими правами. Команды, которые операционная система откажется выполнять от имени суперпользователя, можно в буквальном смысле сосчитать на пальцах одной руки. В этом усматривается определенная угроза компьютерной безопасности, связанная с человеческим фактором. Достаточно много ответственных действий в системе можно выполнить только от имени администратора. Но привычка постоянно работать в системе с полными правами является опасной как для администратора, так и для защищаемой им компьютерной информации. Администратор тоже человек, и ему свойственно ошибаться.

**Учетные записи пользователей и работа с ними**

Подсистема разграничения доступа ОС Linux, наследующая экономные базовые принципы UNIX, не может зафиксировать права каждого из пользователей на каждый файловый объект. По отношению к каждому из файлов пространство пользователей делится на три неравные по численности категории: одного владельца файла, членов его основной группы и всех остальных зарегистрированных пользователей.

Пользователей в целях удобства администрирования можно объединять в группы, которым также присваиваются символьные имена и уникальные числовые идентификаторы GID (Group ID). Точнее: при правильном планировании вначале создаются группы, а затем в них включаются пользователи. Существование групп предусмотрено функционированием системных алгоритмов, и администратор должен это учитывать. Если иного не предусмотрено командой или настройками, при создании новой учетной записи пользователя автоматически создается новая группа, включающая этого пользователя и наследующая его имя. Настройками конфигурационных файлов могут предусматриваться группы, в которые пользователи включаются «по умолчанию», например `users`. Если этого не учитывать, зарегистрированные независимо друг от друга пользователи могут оказаться групповыми совладельцами файлов с конфиденциальной информацией.

Минимальная численность группы – один пользователь. Поэтому для учета GID в метаданных каждого файла также предусматриваются поля общим размером в 4 байта.

Для регистрации пользователей и создания групп требуются полномочия администратора.

Группы совершенно равноправны, но по отношению к конкретному пользователю и его файлам группы могут быть основными и дополнительными. В командах `useradd` и `usermod`, которые упоминаются ниже, основная группа пользователя указывается после параметра `–g`, а дополнительные перечисляются после параметра `–G`. Основная группа для пользователя и его файлов единственна, а дополнительных групп может быть много. Пользователи, включенные в основную группу пользователя, обладают особыми правами на его файлы. Члены дополнительных групп, куда может входить пользователь, имеют общие права на его файлы. В то же время он сам по отношению к файлам пользователей, входящих в дополнительные группы, пользуется групповыми правами. В такой асимметрии заложена возможность разграничения доступа, когда одни пользователи должны иметь больше прав, чем другие.

**Права доступа к файлам**

Изначально каждый файл имел три параметра доступа. Вот они:

- **Чтение** - разрешает получать содержимое файла, но на запись нет. Для каталога позволяет получить список файлов и каталогов, расположенных в нем;
- **Запись** - разрешает записывать новые данные в файл или изменять существующие, а также позволяет создавать и изменять файлы и каталоги;
- **Выполнение** - вы не можете выполнить программу, если у нее нет флага выполнения. Этот атрибут устанавливается для всех программ и скриптов, именно с помощью него система может понять, что этот файл нужно запускать как программу.

Но все эти права были бы бессмысленными, если бы применялись сразу для всех пользователей. Поэтому каждый файл имеет три категории пользователей, для которых можно устанавливать различные сочетания прав доступа:

- **Владелец** - набор прав для владельца файла, пользователя, который его создал или сейчас установлен его владельцем. Обычно владелец имеет все права, чтение, запись и выполнение.
- **Группа** - любая группа пользователей, существующая в системе и привязанная к файлу. Но это может быть только одна группа и обычно это группа владельца, хотя для файла можно назначить и другую группу.
- **Остальные** - все пользователи, кроме владельца и пользователей, входящих в группу файла.

Именно с помощью этих наборов полномочий устанавливаются права файлов в linux. Каждый пользователь может получить полный доступ только к файлам, владельцем которых он является или к тем, доступ к которым ему разрешен. Только пользователь root может работать со всеми файлами независимо от их набора их полномочий.

Но со временем такой системы стало не хватать и было добавлено еще несколько флагов, которые позволяют делать файлы не изменяемыми или же выполнять от имени суперпользователя, их мы рассмотрим ниже.

**Специальные права доступа к файлам**

Для того, чтобы позволить обычным пользователям выполнять программы от имени суперпользователя без знания его пароля была придумана такая вещь, как SUID и SGID биты. Рассмотрим эти полномочия подробнее.

- **SUID** - если этот бит установлен, то при выполнении программы, id пользователя, от которого она запущена заменяется на id владельца файла. Фактически, это позволяет обычным пользователям запускать программы от имени суперпользователя;
- **SGID** - этот флаг работает аналогичным образом, только разница в том, что пользователь считается членом группы, с которой связан файл, а не групп, к которым он действительно принадлежит. Если SGID флаг установлен на каталог, все файлы, созданные в нем, будут связаны с группой каталога, а не пользователя. Такое поведение используется для организации общих папок;
- **Sticky-bit** - этот бит тоже используется для создания общих папок. Если он установлен, то пользователи могут только создавать, читать и выполнять файлы, но не могут удалять файлы, принадлежащие другим пользователям.

**Консольные команды:**

К сожалению, не для всех команд есть перевод `man` на русский язык. Если хочется читать справку на русском, её можно найти [здесь](https://www.opennet.ru/man.shtml).

- `sudo` - позволяет выполнить команду от имени другого пользователя (по умолчанию от root);
- `useradd` - добавление нового пользователя в систему;
- `passwd` - изменяет пароль пользователя;
- `su` - похоже на `sudo`, но в основном предназначена для переключения между пользователями [su vs sudo](http://rus-linux.net/MyLDP/admin/sudo-su.html);
- `chmod` - изменяет права доступа к файлу/каталогу.
- `chown` - изменяет владельца и/или группу для каждого заданного файла/каталога;
- `groupadd` - добавление (создание) новой группы в системе;
- `usermod` - изменение регистрационной информации о пользователе в системе;
- `chgrp` - изменение группы для файлов /каталогов.
- `gpasswd` - работает с файлами `/etc/group` и `/etc/gshadow`;
- `groupdel` - удаляет группу из системы;
- `userdel` - удаляет пользователя из системы;

## Задания к практической работе

Каждую выполненную вами команду и результат её работы поместите в отчёт в виде скриншота (кроме тех, которые касаются man). Если несколько команд и их выводы видны на одном скриншоте, в отчет можно вставить 1 скриншот на несколько команд.

 - Откройте терминал;
 - Ознакомьтесь с возможностями команды `sudo ` c помощью команды `man`;
 - Ознакомьтесь с возможностями команды `useradd ` c помощью команды `man`;
 - Создайте нового пользователя "user1" при помощи команды `useradd` с ключами `-m` и `-s /usr/bin/bash`. Ключ `-m` предписывает создание домашнего каталога пользователя с его именем. Ключ `-s` устанавливает какой командный интерпретатор использовать по умолчанию.
 - Ознакомьтесь с возможностями команды `passwd ` c помощью команды `man`;
 - Установите пользователю "user1" пароль "1234" с помощью команды `passwd`;
 - Аналогичным образом создайте пользователя "user2";
 - Ознакомьтесь с возможностями команды `su ` c помощью команды `man`;
 - Откройте 2 дополнительных терминала. Залогиньтесь в первом как "user1", а во втором как "user2" при помощи команды `su` с ключом `-l` или просто `-` ;
 - В первом терминале залогиньтесь под суперпользователем (root) при помощи `sudo su -`;
 - Посмотрите права установленные для каталога `/home/user1/`
 - Из терминала "user2" попробуйте войти в каталог `/home/user1/`.
 - Ознакомьтесь с возможностями команды `chmod ` c помощью команды `man`;
 - Из терминала "user1" измените права доступа к каталогу `/home/user1/` на 700.
 - Посмотрите права установленные для каталога `/home/user1/`
 - Из терминала "user2" выйдите, а затем снова попробуйте войти в каталог `/home/user1/`.
 - Попробуйте перейти в `/home/user1/` из терминала с root;
 - Из терминала root создайте файл "file1.txt" с содержимым "made by root" в каталоге `/home/user1/`;
 - Из терминала "user1" попробуйте прочитать содержимое "file1.txt", а затем изменить его.
 - Ознакомьтесь с возможностями команды `chown ` c помощью команды `man`;
 - Из терминала root измените владельца файла "file1.txt" на "user1";
 - Из терминала "user1" попробуйте изменить "file1.txt", а затем удалите его.
 - Из терминала root создайте каталог `/var/share/`;
 - Установите ему права доступа 770;
 - Ознакомьтесь с возможностями команды `groupadd ` c помощью команды `man`;
 - Создайте группу "project" с помощью команды `man`;
 - Проверьте, что группа действительно создана при помощи просмотра файла `/etc/group`;
 - Ознакомьтесь с возможностями команды `usermod` c помощью команды `man`;
 - Добавьте пользователей "user1" и "user2" в группу "project" (как их дополнительную группу) при помощи команды `usermod` с ключами `-a` и `-G`.
   Ключ `-G`, заменяет доп. группы, в которых состоит, пользователь на указанные.
   Ключ `-a`, меняет поведение ключа `-G` на добавление групп вместо замены.
 - Ознакомьтесь с возможностями команды `chgrp` c помощью команды `man`;
 - Измените группу для каталога `/var/share/` на "project" при помощи команды `chgrp`;
 - Из терминала "user1" попробуйте перейти в каталог `/var/share/`. Сейчас это не должно получиться. Чтобы изменения вступили в силу, нужно перелогинится.
 - Используйте `exit` в терминалах "user1" и "user2", чтобы разлогиниться. Затем снова зайдите под этими пользователями.
 - Перейдите в каталог `/var/share/` в каждом терминале.
 - Из терминала "user1" создайте файл "file2.txt" с любым текстом.
 - Из терминала "user2" попробуйте изменить файл "file2.txt".
 - Проверьте права доступа к файлу. Как видно, несмотря на то, что каталог и оба пользователя состоят в группе "project" файлы по прежнему создаются с основной группой пользователя.
 - Изучите материал касающийся расширенных разрешений: https://habr.com/ru/post/469667/ 
 - В терминале "root" воспользуетесь командой `chmod g+s /var/share/`.
 - Из терминала "user1" создайте файл "file3.txt" с любым текстом и проверьте права доступа к файлу.
 - Ознакомьтесь с возможностями команды `gpasswd` c помощью команды `man`;
 - Удалите пользователей "user1" и "user2" из группы "project" при помощи команды `gpasswd` с ключом `-d`;
 - Ознакомьтесь с возможностями команды `groupdel` c помощью команды `man`;
 - Удалите группу "project" при помощи команды `groupdel`;
 - Ознакомьтесь с возможностями команды `userdel` c помощью команды `man`;
 - Удалите пользователей "user1" и "user2" с помощью команды `userdel` с ключом `-r`;

## Вопросы к практическому заданию

Ответы на следующие вопросы поместите в отчёт:

  1. Какой пароль устанавливается по умолчанию у пользователя созданного командой `useradd`?
  2. Могут ли существовать пользователи с одинаковым UID?
  3. Должен ли пользователь root вводить старый пароль при его смене с помощью команды `passwd`?
  4. Что будет, если выполнить команду (от имени root): `usermod -G users`?
  5. Можно ли назначить своей учётной записи права пользователя root. А затем удалить пользователя root из системы?
  6. Имеет ли возможность пользователь созданный командой `useradd` (без доп. параметров) пользоваться командой `sudo`? Если нет, то как можно дать ему такую возможность?
  7. Сколько времени по умолчанию команда `sudo` помнит введённый пароль?
  8. Достаточно ли запретить доступ на запись, чтобы предотвратить возможность удаления файла? Если нет, тогда как это сделать?
  9. Как можно узнать права доступа к файлу/каталогу?
  10. Какие права доступа нужно установить каталогу, чтобы все вновь созданные файлы и каталоги в нём получали группу этого каталога?

## Отчёт

Оформите отчёт в соответствии с шаблоном и загрузите его в элемент Задание с номером работы в мудле.
